# Batched Ewald: Mixed approach

This is an (experimental) implementation of batched Ewald summation. It turns out that even though it "wastes" a lot of computation, it is most efficient to batch the reciprocal-space part of Ewald summation by (a) flattening the k-grid per structure into a single flat dimension, (b) padding this dimension to the larges size in the batch, and (c) doing `vmap` over the leading batch dimension. On the other hand, it's slightly better to batch the real-space part by putting all pairs into a flat array and then doing `segment_sum` and indexing. This is particularly slightly better for GNNs acting purely on the SR part. This also more naturally accomodates mixed PBC and no-PBC structures.

This sub-package implements this mixed approach: Most of the logic is dedicated to preparing the batches, the calculator itself is very simple and mostly just dispatches back to the original `jax-pme` solver.